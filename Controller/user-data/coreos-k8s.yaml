#cloud-config

coreos:
    units:
       - name: kubernetes-download.service
         command: start
         enable: true
         content: |
             [Unit]
             Description=Kubernetes Start script
             Documentation=https://github.com/slintes/CoreOSKubernetesTest

             [Service]
             Type=oneshot
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-download.service

             [Install]
             WantedBy=multi-user.target

       - name: kubernetes.service
         command: start
         enable: true
         content: |
             [Unit]
             Description=Kubernetes Start script
             Documentation=https://github.com/slintes/CoreOSKubernetesTest
             Requires=etcd.service fleet.service kubernetes-download.service
             After=docker-registry.service kubernetes-download.service

             [Service]
             Type=oneshot
             RemainAfterExit=yes
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-proxy.service
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-kubelet.service
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-apiserver.service
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-scheduler.service
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-controller-manager.service
             ExecStart=/usr/bin/fleetctl start --no-block /home/core/fleet-units/kube-register.service
             ExecStartPost=/home/core/bin/create-k8s-env.sh
             Restart=no

             [Install]
             WantedBy=multi-user.target

       - name: inaetics-k8s-services.service
         command: start
         enable: true
         content: |
             [Unit]
             Description=INAETICS demonstrator Kubernetes services
             Documentation=https://github.com/slintes/CoreOSKubernetesTest
             Requires=kubernetes.service
             After=kubernetes.service

             [Service]
             Type=oneshot
             RemainAfterExit=yes
             EnvironmentFile=/etc/kubernetes.env
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/ace-provisioning-service.json
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/amdatu-viewer-service.json
             Restart=no

             [Install]
             WantedBy=multi-user.target

       - name: inaetics-k8s-controllers.service
         command: start
         enable: true
         content: |
             [Unit]
             Description=INAETICS demonstrator Kubernetes controllers
             Documentation=https://github.com/slintes/CoreOSKubernetesTest
             Requires=kubernetes.service
             After=kubernetes.service

             [Service]
             Type=oneshot
             RemainAfterExit=yes
             EnvironmentFile=/etc/kubernetes.env
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/ace-provisioning-controller.json
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/amdatu-datastore-viewer-controller.json
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/amdatu-processor-controller.json
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/amdatu-producer-controller.json
             ExecStart=/opt/bin/kubectl create -f /home/core/inaetics-demo/k8s/amdatu-queue-controller.json
             Restart=no

             [Install]
             WantedBy=multi-user.target

###EOF###
